#!/bin/bash

# Copyright (C) 2022  Alin Eugen Deac <aedart@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

# Set error handling
set -o errexit  # abort on nonzero exit status
set -o nounset  # abort on unbound variable
set -o pipefail # don't hide errors within pipes

# Define a few paths
readonly SCRIPT_PATH=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
readonly WORKING_DIR=$( cd -- "$( dirname -- "$SCRIPT_PATH" )" &> /dev/null && pwd)

# Navigate to working directory
cd "$WORKING_DIR"

# Abort if not within a git repository... not sure when this is the case, but still!
if [ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" != "true" ]; then
    echo 'No git repository detected' >&2
    exit 1
fi

# The final version to put into file
version='unknown'

# Obtain latest tag
if git describe --tags --abbrev=0 &> /dev/null ; then
    echo 'Found version from git tag'
    version=$(git describe --tags --abbrev=0)
else
    # No tags available... obtain latest hash
    echo 'No tags available...'
    version="dev@$(git rev-parse --short HEAD)"
fi

# Set or overwrite version
echo "Writing ${version} to '${WORKING_DIR}/version' file"
echo "${version}" > version
exit 0